<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root {
            --bg-main: #1E2019;
            --bg-container: #393E41;
            --border-color: #93A29B;
            --text-primary: #DDD78D;
            --text-secondary: #93A29B;
            --accent: #DCBF85;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-secondary); 
        }
        .main-container {
             background-color: var(--bg-container);
             border: 1px solid var(--border-color);
        }
        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--text-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        .loader-small {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--text-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-file-upload {
            border: 2px dashed var(--border-color);
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .custom-file-upload.dragover {
            background-color: var(--bg-main);
            border-color: var(--text-primary);
        }
        .answer-option {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .answer-option:hover:not(.disabled) {
            border-color: var(--text-primary);
            transform: translateY(-2px);
        }
        .answer-option.correct {
            border-color: #3fb950;
            background-color: rgba(46, 160, 67, 0.15);
        }
        .answer-option.incorrect {
            border-color: #f85149;
            background-color: rgba(248, 81, 73, 0.15);
        }
        .answer-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .answer-option.answer-hidden {
            background-color: #374151;
            border-color: var(--border-color);
            color: transparent;
            pointer-events: none;
        }
        .answer-option.answer-hidden .hide-answer-btn {
            pointer-events: auto;
        }
        .explanation {
            color: var(--text-secondary); 
        }
        .explanation p {
            display: inline;
            margin: 0;
        }
        .form-element {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        .form-element:focus {
            border-color: var(--text-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(221, 215, 141, 0.3);
        }
        .primary-btn {
            background-color: var(--text-primary);
            color: var(--bg-main);
            border: 1px solid var(--text-primary);
        }
        .primary-btn:hover:not(:disabled) {
             filter: brightness(1.1);
        }
        .nav-btn {
            background-color: var(--bg-container);
            border: 1px solid var(--border-color);
            color: var(--accent);
        }
        .nav-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background-color: var(--bg-main);
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .file-item {
            border-width: 2px;
            transition: border-color 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-300">

    <div class="container mx-auto max-w-4xl px-4 py-8 sm:py-12">
        <header id="main-header" class="text-center mb-10 sm:mb-12">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white">Quiz Generator</h1>
        </header>

        <main>
            <div id="config-section" class="main-container p-4 sm:p-6 md:p-8 rounded-xl shadow-lg transition-all">
                <div class="space-y-8">
                    <div>
                        <h2 class="text-xl font-semibold mb-4 text-white">1. Upload Your Content</h2>
                        <div id="drop-zone" class="custom-file-upload w-full text-center block p-6 sm:p-10 rounded-lg">
                            <svg class="w-10 h-10 sm:w-12 sm:h-12 mx-auto text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                            </svg>
                            <p class="mt-4 text-lg font-medium text-gray-400">Choose a file or drag & drop it here</p>
                            <p class="mt-1 text-sm text-gray-500">PDF formats, up to 50MB</p>
                            <button id="browse-btn" type="button" class="mt-6 bg-gray-700 border border-gray-600 text-gray-300 font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition-all">
                                Browse File
                            </button>
                        </div>
                        <input id="file-upload" type="file" class="hidden" accept=".pdf" multiple>
                        <div id="uploaded-files-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-4 text-white">2. Customize Your Quiz</h2>
                        <div class="grid grid-cols-1">
                             <div>
                                <label for="question-style" class="block text-sm font-medium text-gray-400 mb-2">Question Style</label>
                                <select id="question-style" class="w-full p-3 form-element rounded-lg transition">
                                    <option value="standard">Standard</option>
                                    <option value="vignette">Vignette</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6">
                             <label for="custom-prompt" class="block text-sm font-medium text-gray-400 mb-2">Customize the Prompt (Optional)</label>
                             <textarea id="custom-prompt" rows="3" class="w-full p-3 form-element rounded-lg transition" placeholder="Add additional details or instructions here..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <button id="generate-quiz-btn" class="primary-btn w-full sm:w-auto font-bold py-3 px-8 rounded-lg hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-yellow-400/50 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100">
                        Generate Quiz
                    </button>
                </div>
            </div>
            
            <div id="loader-section" class="hidden text-center p-8">
                <div class="loader"></div>
                <p class="text-lg text-gray-400">Generating your quiz...</p>
            </div>

            <div id="quiz-section" class="hidden mt-10 main-container p-4 sm:p-6 md:p-8 rounded-xl shadow-lg">
                <p id="quiz-progress" class="text-sm text-gray-400 text-right mb-4"></p>
                <div id="quiz-content">
                     </div>
                <div class="flex flex-col sm:flex-row justify-between mt-8 space-y-3 sm:space-y-0 sm:space-x-4">
                     <button id="previous-question-btn" class="nav-btn w-full sm:w-auto font-bold py-3 px-6 md:px-8 rounded-lg transition-all">Previous</button>
                     <button id="next-question-btn" class="nav-btn w-full sm:w-auto font-bold py-3 px-6 md:px-8 rounded-lg transition-all">Next</button>
                </div>
            </div>

            <div id="results-section" class="hidden mt-10 main-container p-4 sm:p-6 md:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl md:text-3xl font-bold mb-2 text-center text-white">Quiz Complete!</h2>
                <p id="score" class="text-lg md:text-xl font-bold text-center mb-6 text-gray-300"></p>
                
                <div id="review-section" class="hidden mt-6 text-left">
                    <h3 class="text-lg md:text-xl font-semibold mb-4 text-white">Review Incorrect Answers:</h3>
                    <div id="review-content" class="space-y-4 max-h-64 overflow-y-auto pr-2"></div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center mt-8 space-y-3 sm:space-y-0 sm:space-x-4">
                    <button id="new-quiz-btn" class="primary-btn w-full sm:w-auto font-bold py-3 px-8 rounded-lg transition-all">New Quiz (Same Content)</button>
                    <button id="start-over-btn" class="nav-btn w-full sm:w-auto font-bold py-3 px-8 rounded-lg transition-all">Start Over</button>
                </div>
            </div>

            <div id="error-message" class="hidden mt-6 bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>
        </main>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // DOM Elements
        const fileUpload = document.getElementById('file-upload');
        const uploadedFilesList = document.getElementById('uploaded-files-list');
        const generateQuizBtn = document.getElementById('generate-quiz-btn');
        const configSection = document.getElementById('config-section');
        const loaderSection = document.getElementById('loader-section');
        const quizSection = document.getElementById('quiz-section');
        const quizProgress = document.getElementById('quiz-progress');
        const quizContent = document.getElementById('quiz-content');
        const previousQuestionBtn = document.getElementById('previous-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const resultsSection = document.getElementById('results-section');
        const scoreDisplay = document.getElementById('score');
        const reviewSection = document.getElementById('review-section');
        const reviewContent = document.getElementById('review-content');
        const startOverBtn = document.getElementById('start-over-btn');
        const newQuizBtn = document.getElementById('new-quiz-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dropZone = document.getElementById('drop-zone');
        const browseBtn = document.getElementById('browse-btn');
        const mainHeader = document.getElementById('main-header');

        // State
        let uploadedFiles = [];
        let firstQuizData = [];
        let quizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        // Event Listeners
        browseBtn.addEventListener('click', () => fileUpload.click());

        dropZone.addEventListener('click', (e) => {
            if (e.target.id === 'drop-zone') {
                fileUpload.click();
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileUpload.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        async function handleFiles(files) {
            if (!files.length) return;
            
            generateQuizBtn.disabled = true;
            hideError();

            for (const file of files) {
                if (uploadedFiles.some(f => f.name === file.name)) continue;

                const fileIndex = uploadedFiles.length;
                renderUploadedFile(file.name, 'processing', fileIndex);

                try {
                    const reader = new FileReader();
                    const textContent = await new Promise((resolve, reject) => {
                        reader.onload = async (event) => {
                            try {
                                const pdfData = new Uint8Array(event.target.result);
                                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                                let fullText = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const pageContent = await page.getTextContent();
                                    fullText += pageContent.items.map(item => item.str).join(' ');
                                }
                                resolve(fullText);
                            } catch (pdfError) {
                                reject(pdfError);
                            }
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsArrayBuffer(file);
                    });
                    
                    uploadedFiles.push({ name: file.name, content: textContent });
                    updateUploadedFileStatus(fileIndex, file.name, 'loaded');

                } catch (error) {
                    console.error(`Failed to process ${file.name}:`, error);
                    updateUploadedFileStatus(fileIndex, file.name, 'error');
                }
            }
            generateQuizBtn.disabled = uploadedFiles.length === 0;
        }
        
        uploadedFilesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-file-btn')) {
                const fileName = e.target.dataset.name;
                uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
                renderAllUploadedFiles();
                generateQuizBtn.disabled = uploadedFiles.length === 0;
            }
        });

        generateQuizBtn.addEventListener('click', () => {
             initiateQuizGeneration(false);
        });
        
        newQuizBtn.addEventListener('click', () => {
            initiateQuizGeneration(true);
        });

        async function initiateQuizGeneration(isNewQuiz = false) {
            if (uploadedFiles.length === 0) {
                showError('Please upload at least one PDF file.');
                return;
            }
            hideError();
            configSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            mainHeader.classList.add('hidden');
            loaderSection.classList.remove('hidden');

            const questionStyle = document.getElementById('question-style').value;
            const customPrompt = document.getElementById('custom-prompt').value;
            let combinedContent = uploadedFiles.map(f => `--- START OF ${f.name} ---\n\n${f.content}\n\n--- END OF ${f.name} ---`).join('\n\n');
            
            const MAX_CONTENT_LENGTH = 150000;
            if (combinedContent.length > MAX_CONTENT_LENGTH) {
                console.warn(`Content length (${combinedContent.length}) exceeds the maximum of ${MAX_CONTENT_LENGTH}. Truncating content.`);
                combinedContent = combinedContent.substring(0, MAX_CONTENT_LENGTH);
            }
            
            let basePrompt;
            if (isNewQuiz) {
                const previousQuestionsText = firstQuizData.map(q => q.question).join('\n');
                basePrompt = `You are generating a follow-up quiz. The user has already taken one quiz based on the provided content.
                The following questions were on the FIRST quiz and should be avoided:
                ${previousQuestionsText}
                Your task is to generate a NEW 20-question multiple choice quiz that covers new concepts and information from the provided content that were NOT tested in the first quiz. Ensure there is no overlap in the topics or specific facts being tested.`;
            } else {
                 if (questionStyle === 'vignette') {
                    basePrompt = `Generate a 20 question multiple choice quiz based on the lecture content. The questions must be challenging, practical, situational-based vignettes. Each vignette should be a single, coherent question that presents a scenario with key details and then asks for a conclusion based on that information. The question should not explicitly label parts like "Scenario" or "Problem". For example, a good vignette question should read as a single paragraph like this: "Following a car accident in which the patient received a deep laceration on the medial side of his right knee, the patient notices numbness along the medial side of his right leg and foot. He has no motor deficit. The nerve which appears to have been injured is the:". Your task is to create questions in this integrated style, using the provided content to build the scenarios. The goal is to test the application of knowledge, not just recall of facts. Do not simply ask for definitions.`;
                } else { // standard
                    basePrompt = `Generate a 20 question multiple choice quiz based on the lecture content, targeted at a master's level student. The questions must be exceptionally difficult and designed to test a deep, integrated understanding of the material. They must go beyond simple recall and require critical thinking.
                    Key requirements for each question:
                    1. Advanced Question Formulation: Questions should force the user to synthesize concepts from the text. Questions that test on subtle distinctions between closely related concepts are preferred.
                    2. Highly Plausible Distractors: All incorrect answer choices must be highly plausible and represent common errors, subtle misconceptions, or concepts that are true but not the *best* answer to the specific question. The distractors should be tempting and require careful consideration.
                    3. Strictly Conceptual (No Vignettes): The questions must be direct and conceptual. **Do not use patient scenarios or clinical vignettes.** Focus on the underlying principles, mechanisms, and classifications.
                    4. Avoid Structural Clues: Ensure all answer choices (correct and incorrect) are of similar length, detail, and grammatical structure. Avoid making the correct answer obvious through formatting or length.
                    5. Comprehensive and Varied Topic Selection: Ensure the questions are drawn from the entire breadth of the provided document. Do not focus only on the main headings or summaries. Actively seek out and test on a wide variety of concepts, including both major themes and specific, nuanced details found throughout the text.`;
                }
            }

            const finalPrompt = `${basePrompt} ${customPrompt}`;

            try {
                const result = await generateQuiz(combinedContent, finalPrompt);

                quizData = result;
                if (!quizData || quizData.length === 0) {
                    throw new Error("AI failed to generate questions. Please try a different file or prompt.");
                }
                
                quizData.forEach(q => shuffle(q.options));

                if (!isNewQuiz) {
                    firstQuizData = JSON.parse(JSON.stringify(quizData));
                }

                currentQuestionIndex = 0;
                userAnswers = new Array(quizData.length).fill(null);
                loaderSection.classList.add('hidden');
                quizSection.classList.remove('hidden');
                showQuestion();
            } catch (error) {
                handleError(error);
            }
        }


        nextQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            } else {
                showFinalResults();
            }
        });

        previousQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        });
        
        quizContent.addEventListener('click', (e) => {
            const hideBtn = e.target.closest('.hide-answer-btn');
            if (hideBtn) {
                e.stopPropagation();
                const parentOption = hideBtn.closest('.answer-option');
                parentOption.classList.toggle('answer-hidden');
                
                const eyeOpen = hideBtn.querySelector('.eye-open');
                const eyeClosed = hideBtn.querySelector('.eye-closed');
                eyeOpen.classList.toggle('hidden');
                eyeClosed.classList.toggle('hidden');
                return;
            }

            const selectedOption = e.target.closest('.answer-option');
            if (selectedOption && !selectedOption.classList.contains('disabled')) {
                handleAnswerSelection(selectedOption);
            }
        });

        startOverBtn.addEventListener('click', resetUIForStartOver);

        // UI Rendering Functions
        function renderUploadedFile(name, status, index) {
            const fileEl = document.createElement('div');
            fileEl.id = `file-item-${index}`;
            fileEl.className = 'file-item flex items-center justify-between p-3 rounded-lg border-2 border-gray-300';
            
            fileEl.innerHTML = `
                <span class="text-sm text-gray-400 truncate pr-2">${name}</span>
                <div class="flex items-center space-x-2">
                    <div class="file-status"></div>
                    <button data-name="${name}" class="remove-file-btn text-red-500 hover:text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            uploadedFilesList.appendChild(fileEl);
            updateUploadedFileStatus(index, name, status);
        }

        function updateUploadedFileStatus(index, name, status) {
            const fileEl = document.getElementById(`file-item-${index}`);
            if (!fileEl) return;
            const statusDiv = fileEl.querySelector('.file-status');
            fileEl.classList.remove('border-green-500', 'border-red-500', 'border-gray-300', 'border-dashed');

            if (status === 'loaded') {
                fileEl.classList.add('border-green-500');
                statusDiv.innerHTML = ``;
            } else if (status === 'error') {
                fileEl.classList.add('border-red-500');
                statusDiv.innerHTML = `<span class="text-red-500 text-xs">Failed</span>`;
            } else { // processing
                fileEl.classList.add('border-gray-300', 'border-dashed');
                statusDiv.innerHTML = `<div class="loader-small"></div>`;
            }
        }
        
        function renderAllUploadedFiles() {
            uploadedFilesList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                renderUploadedFile(file.name, 'loaded', index);
            });
        }

        // Gemini API Calls
        async function callGeminiAPI(prompt, schema = null) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                };
            }
            
            // This is the only part that changes:
            // We now call our own secure function instead of the Google API directly.
            const apiUrl = `/api/generate`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }

            // The rest of the logic remains the same, as our function returns the same format.
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                throw new Error("Received an unexpected response from the AI.");
            }
        }
        
        async function generateQuiz(content, promptText) {
            const fullPrompt = `${promptText}
            IMPORTANT: All questions, options, and explanations MUST be based exclusively on the provided content below. Do not use any external knowledge.
            Content: --- ${content} ---
            Provide the output as a valid JSON array of objects.`;
            
            const quizSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        question: { type: "STRING" },
                        options: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    option_text: { type: "STRING" },
                                    is_correct: { type: "BOOLEAN" },
                                    explanation: { type: "STRING", description: "A concise, one-sentence explanation for why this specific option is correct or incorrect. Do not include conversational filler." },
                                },
                                required: ["option_text", "is_correct", "explanation"],
                            },
                        },
                    },
                    required: ["question", "options"],
                },
            };

            const jsonString = await callGeminiAPI(fullPrompt, quizSchema);
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse JSON from API response:", jsonString);
                throw new Error("Could not parse the quiz data from the AI.");
            }
        }

        // Quiz Logic Functions
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showQuestion() {
            quizContent.innerHTML = '';
            const q = quizData[currentQuestionIndex];
            quizProgress.textContent = `${currentQuestionIndex + 1} / ${quizData.length}`;

            const questionEl = document.createElement('div');
            questionEl.innerHTML = `<h3 class="text-xl mb-6 text-white">${q.question}</h3>`;

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-3';
            q.options.forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'answer-option p-4 rounded-lg';
                optionEl.dataset.index = index;
                optionEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="option-text flex-grow">${option.option_text}</span>
                        <button class="hide-answer-btn p-1 rounded-full hover:bg-gray-700 ml-4 flex-shrink-0">
                            <svg class="eye-open w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <svg class="eye-closed hidden w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                            </svg>
                        </button>
                    </div>
                    <div class="explanation hidden mt-3 pt-3 border-t border-gray-700"></div>`;
                optionsContainer.appendChild(optionEl);
            });
            questionEl.appendChild(optionsContainer);
            quizContent.appendChild(questionEl);

            updateNavButtons();

            if (userAnswers[currentQuestionIndex] !== null) {
                redisplayAnsweredState();
            }
        }

        function handleAnswerSelection(selectedElement) {
            const selectedIndex = parseInt(selectedElement.dataset.index, 10);
            userAnswers[currentQuestionIndex] = selectedIndex;
            
            const options = quizContent.querySelectorAll('.answer-option');
            options.forEach((opt, index) => {
                const optionData = quizData[currentQuestionIndex].options[index];
                opt.classList.add('disabled');
                opt.querySelector('.hide-answer-btn').disabled = true;
                
                const explanationDiv = opt.querySelector('.explanation');
                
                if (optionData.is_correct) {
                    opt.classList.remove('answer-hidden');
                    opt.querySelector('.eye-open').classList.remove('hidden');
                    opt.querySelector('.eye-closed').classList.add('hidden');
                    opt.classList.add('correct');
                } else if (index === selectedIndex) {
                    opt.classList.add('incorrect');
                }
                
                if (index === selectedIndex || optionData.is_correct) {
                    explanationDiv.innerHTML = marked.parse(optionData.explanation);
                    explanationDiv.classList.remove('hidden');
                }
            });
            updateNavButtons();
        }
        
        function redisplayAnsweredState() {
            const selectedIndex = userAnswers[currentQuestionIndex];
            if (selectedIndex === null) return;

            const options = quizContent.querySelectorAll('.answer-option');
            const selectedEl = options[selectedIndex];
            
            if (selectedEl) {
                handleAnswerSelection(selectedEl);
            }
        }

        function updateNavButtons() {
            previousQuestionBtn.disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === quizData.length - 1) {
                nextQuestionBtn.textContent = 'Finish';
            } else {
                nextQuestionBtn.textContent = 'Next';
            }
        }

        function showFinalResults() {
            quizSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            mainHeader.classList.remove('hidden');
            
            let score = 0;
            const incorrectQuestions = [];
            userAnswers.forEach((answerIndex, questionIndex) => {
                if (answerIndex !== null) {
                    const question = quizData[questionIndex];
                    const selectedOption = question.options[answerIndex];
                    if (selectedOption.is_correct) {
                        score++;
                    } else {
                        incorrectQuestions.push({
                            questionData: question,
                            userAnswerIndex: answerIndex
                        });
                    }
                }
            });

            scoreDisplay.textContent = `You scored ${score} out of ${quizData.length}!`;
            reviewContent.innerHTML = '';

            if (incorrectQuestions.length > 0) {
                reviewSection.classList.remove('hidden');
                incorrectQuestions.forEach(item => {
                    const q = item.questionData;
                    const userAnswer = q.options[item.userAnswerIndex].option_text;
                    const correctAnswer = q.options.find(opt => opt.is_correct).option_text;
                    const explanation = q.options.find(opt => opt.is_correct).explanation;

                    const reviewEl = document.createElement('div');
                    reviewEl.className = 'bg-gray-800 p-4 rounded-lg shadow';
                    reviewEl.innerHTML = `
                        <p class="text-white mb-2">${q.question}</p>
                        <p class="text-sm"><span class="text-red-400">Your Answer:</span> ${userAnswer}</p>
                        <p class="text-sm"><span class="text-green-400">Correct Answer:</span> ${correctAnswer}</p>
                        <p class="text-sm mt-1 italic text-gray-500">${explanation}</p>
                    `;
                    reviewContent.appendChild(reviewEl);
                });
            }
        }
        
        // UI Utility Functions
        function resetUIForStartOver() {
            configSection.classList.remove('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            mainHeader.classList.remove('hidden');
            uploadedFilesList.innerHTML = '';
            uploadedFiles = [];
            firstQuizData = [];
            generateQuizBtn.disabled = true;
            reviewSection.classList.add('hidden');
            reviewContent.innerHTML = '';
            hideError();
        }

        function handleError(error) {
            loaderSection.classList.add('hidden');
            mainHeader.classList.remove('hidden');
            let userMessage = 'Failed to generate quiz. Please try again.';
            if (error.message.includes('401')) {
                userMessage = 'There was an authentication issue with the AI service. Please try again shortly.';
            } else if (error.message.includes('unexpected response') || error.message.includes('Could not parse')) {
                userMessage = 'The AI returned an invalid response. Please try adjusting your prompt or files.';
            }
            showError(userMessage);
            console.error('Error:', error);
            resultsSection.classList.add('hidden'); 
            configSection.classList.remove('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>
